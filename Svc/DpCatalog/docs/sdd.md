\page SvcDpCatalogComponent Svc::DpCatalog Component
# Svc::DpCatalog Component

## 1 Introduction

`DpCatalog` is an active FÂ´ component that manages the downlink of generate data products. The data products were previously generated by components into a project-specific set of directories. Upon command, `DpCatalog` will build a catalog of data existing products and start downloading them. They are downloaded based on a priority stored in the file and by generation time. `DpCatalog` also has commands to reprioritize and delete data products.

## 2 Requirements

Requirement | Description | Rationale | Verification Method
---- | ---- | ---- | ----
SVC-DPCAT-001 | `DpCatalog` shall read a set of directories and build a list of data products. | `DpCatalog` needs to know at least one directory where data products reside  | Test
SVC-DPCAT-002 | `DpCatalog` shall sort data products first based on the internally recorded priority. | `DpCatalog` needs to downlink highest priority items first | Test
SVC-DPCAT-003 | `DpCatalog` shall sort data products second based on the internally recorded time with oldest products as higher priority. | `DpCatalog` needs to downlink oldest items first | Test
SVC-DPCAT-004 | `DpCatalog` shall sort data products third based on the internally recorded product ID with the lowest as higher priority. | `DpCatalog` needs to resolve case where priority and time match | Test
SVC-DPCAT-005 | `DpCatalog` shall update the data product metadata once download is complete | `DpCatalog` needs to track completion status to avoid duplicate downloads | Test
SVC-DPCAT-006 | `DpCatalog` shall implement a command to build the catalog. | `DpCatalog` needs to downlink oldest items first | Test
SVC-DPCAT-007 | `DpCatalog` shall implement a way to insert newly-generated data products into the catalog after the catalog is built | `DpCatalog` should notice new products and not require a rebuild of the catalog | Test
SVC-DPCAT-008 | `DpCatalog` shall implement commands to modify the priority of existing data products | Operators made change the priority to lower or raise priorities due to troubleshooting, etc | Test
SVC-DPCAT-009 | `DpCatalog` shall implement commands to delete data products | Ground tools can use DpManager commands to automatically delete DPs | Test

## 3 Design

### 3.1 Assumptions

The design of `DpCatalog` assumes the following:

1. A file system exists to store the data product files.
2. The contents of the data product files match the data product specification.
3. The file downlink will acknowledge completion of each file

### 3.3 Ports

#### 3.3.1 Role Ports

Name | Type | Role
-----| ---- | ----
`timeCaller` | `Fw::Time` | TimeGet
`cmdIn` | [`Fw::Cmd`](../../../Fw/Cmd/docs/sdd.html) | Cmd
`cmdRegOut` | [`Fw::CmdReg`](../../../Fw/Cmd/docs/sdd.html) | CmdReg
`cmdResponseOut` | [`Fw::CmdResponse`](../../../Fw/Cmd/docs/sdd.html) | CmdResponse
`tlmOut` | [`Fw::Tlm`](../../../Fw/Tlm/docs/sdd.html) | Telemetry
`eventOut` | [`Fw::LogEvent`](../../../Fw/Log/docs/sdd.html) | LogEvent

#### 3.3.2 Component-Specific Ports

Name | Type | Kind | Purpose
---- | ---- | ---- | ----
sendFile|SendFileRequest|output|Send next file to downlink
fileDone|SendFileComplete|async_input|Last requested file is complete
newDp|DpNotify|async_input|Notification that a new DP has been generated

### 3.4 Constants

`DpCatalog` can be statically configured with the following constants:

|Constant|Purpose|
|---|---|
|MAX_DP_DIRS|Maximum directories that can be provided for DPs

### 3.5 Configuration

During initialization, the intialization function takes a set of parameters:

|Psrameter|Purpose|
|---|---|
|dpDirs|A set of strings up to `MAX_DP_DIRS` that are directory names where DPs are written
|maxFiles|Specify the maximum number of files the catalog can track|
|allocator|Memory allocator for catalog records

### TODO From here

`FileDownlink` has the following constants, initialized
at component instantiation time:

* *downlinkPacketSize*: The size of the packets to use on downlink.
* *timeout*: Max amount of time in ms to wait for a buffer return before aborting downlink
* *cooldown*: The amount of time in ms to wait in a cooldown state before starting next downlink.
* *cycle time*: Frequency in ms of clock pulses sent to `Run` port, used for timing timeouts and
  cooldown.
* *file queue depth*: The maximum number of files that can be held in the internal file downlink
  queue. Attempting to dispatch a SendFile command or port call while the queue is full will result
  in a busy error response.

### 3.6 State

`FileDownlink` maintains a *mode* equal to
one of the following values:

* IDLE (0): `FileDownlink` is idle.

* DOWNLINK (1): `FileDownlink` is performing a file downlink.

* CANCEL (2): `FileDownlink` is canceling a file downlink.

* WAIT (3): `FileDownlink` is waiting for a buffer to be returned before sending another packet.

* COOLDOWN (4): `FileDownlink` is waiting in a cooldown period before downlinking the next file.

The initial value is IDLE.

### 3.6 Commands

`FileDownlink` recognizes the commands described in the following sections.

#### 3.6.1 SendFile/SendPartial

SendFile is an asynchronous command that adds a file to the file downlink queue.
It has two arguments:

1. *sourceFileName*: The name of the on-board file to send.
2. *destFileName*: The name of the destination file on the ground.

SendPartial also includes the following fields:

3. *offset*: Position in file to start reading from.
4. *length*: Amount of data to read. A length of 0 reads until the end of file.

When the downlink completes or fails, a CmdResponse packet will be sent indicating success or
failure.

#### 3.6.2 Cancel

Cancel is a synchronous command.
If *mode* = DOWNLINK, it sets *mode* to CANCEL.
Otherwise it does nothing.

## 4 Checklists

Document | Link
-------- | ----
Design | [Link](Checklist/design.xlsx)
Code | [Link](Checklist/code.xlsx)
Unit Test | [Link](Checklist/unit_test.xls)

## 6 Unit Testing

TODO
