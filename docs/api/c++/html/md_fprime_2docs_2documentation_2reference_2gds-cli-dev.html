<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>F´ Flight Software - C/C++ Documentation: GDS CLI - Developer&#39;s Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">F´ Flight Software - C/C++ Documentation<span id="projectnumber">&#160;devel</span>
   </div>
   <div id="projectbrief">A framework for building embedded system applications to NASA flight quality standards.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_fprime_2docs_2documentation_2reference_2gds-cli-dev.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">GDS CLI - Developer's Guide</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md97"></a></p>
<p>This guide is for programmers who intend to maintain and develop code for the Ground Data System's command-line interface suite. For regular users who just want to use these CLI tools, please see the <a class="el" href="md_fprime_2docs_2documentation_2user-manual_2gds_2gds-cli.html">user guide</a>.</p>
<ul>
<li>CLI Requirements<ul>
<li>Primary Requirements</li>
<li>Secondary Requirements</li>
</ul>
</li>
<li>Architecture<ul>
<li>Intended</li>
<li>As Implemented</li>
<li>Dataflow</li>
<li>Dependencies</li>
<li>Source Files</li>
</ul>
</li>
<li>Tests</li>
<li>Code Quirks</li>
<li>Future Work<ul>
<li>Fixing Issues</li>
<li>New Features</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md98"></a>
CLI Requirements</h1>
<h2><a class="anchor" id="autotoc_md99"></a>
Primary Requirements</h2>
<ul>
<li>Overall goal is to provide a command-line interface for interacting with the F' Ground Data System (GDS), which can be used entirely in place of the GDS GUI<ul>
<li>At a minimum, the CLI tools should allow for receiving all events/telemetry data from the GDS and sending commands to the spacecraft</li>
</ul>
</li>
<li>The CLI tools' output must be usable with existing UNIX utilities through piping/file output/BASH scripting/etc.</li>
<li>The CLI tools should be multi-platform, supporting (at a minimum) Linux, Mac, and Windows systems</li>
<li>If implemented in Python, must support Python 3.6+</li>
</ul>
<h2><a class="anchor" id="autotoc_md100"></a>
Secondary Requirements</h2>
<ul>
<li>Feature parity should be maintained between the GDS GUI and the GDS CLI tools as far as possible</li>
<li>Tools should be performant (finish executing in &lt;100ms unless explicitly waiting for new data)</li>
<li>CLI tools should work "out of the box" with minimal or no setup/configuration</li>
<li>GDS CLI options/names/operations should be consistent with the GDS GUI first, then with other F' CLI tools, then with other UNIX conventions</li>
<li>Should be installable through a single pip command</li>
<li>Should support tab completion</li>
<li>Number of 3rd-party dependencies should be kept to a minimum</li>
<li>Should adhere to an MVC architecture, with parsing/printing separated from business logic</li>
</ul>
<h1><a class="anchor" id="autotoc_md101"></a>
Architecture</h1>
<h2><a class="anchor" id="autotoc_md102"></a>
Intended</h2>
<p><img src="../../img/proposed_architecture.png" alt="" class="inline"/></p>
<p>The intended architecture for the CLI is:</p>
<ul>
<li>A single <code>Parsing</code> module (if possible, a single file) which handles all argument parsing for the CLI tool; it determines what command was called and what arguments were provided to it</li>
<li>The actual command code is executed in a <code>Command</code> module; each CLI command has its own, independent module to handle execution</li>
<li>Any shared code between these modules is refactored into the <code>Common</code> module (notably, no direct calls should be made to the API from a <code>Command</code> module without going through a <code>Common</code> interface first)</li>
</ul>
<p>The CLI will interact with the GDS through an appropriate API, which the CLI modules access through an interface in <code>Common</code>. While the REST API was initially targeted, we later decided to transition to the Integration Test API for now due to its filtering capabilities.</p>
<h2><a class="anchor" id="autotoc_md103"></a>
As Implemented</h2>
<p>Not including imports used only for type hints, or dependencies for modules not part of the GDS CLI source code (generated using <a href="https://pydeps.readthedocs.io/en/latest/">pydeps</a>:</p>
<p><img src="../../img/overall_dependencies_edited.png" alt="" class="inline"/></p>
<p>!!! note The above graph has arrows pointing <b>to</b> the module that does the importing and away from the dependency, and does not include Python standard library imports.</p>
<ul>
<li>All parsing is handled in <code>fprime_cli</code>, which imports the command modules and several external libraries to help with parsing.</li>
<li>Each command is implemented separately, but shares a large portion of its code with other modules via the <code>Common</code> module files, as well as importing the appropriate GDS data type for the type of data it's working with (and, in the case of <code>command_send</code>, an appropriate exception).</li>
<li>The <code>Common</code> module is actually made up of several distinct, independent submodules containing related groups of common code. These import a variety of other GDS modules to help provide all necessary functionality; in particular, the <code>testing_fw.api</code> Integration Test module is used to access the GDS.</li>
</ul>
<h2><a class="anchor" id="autotoc_md104"></a>
Dataflow</h2>
<p><img src="../../img/cli_data_flow.svg" alt="" style="pointer-events: none;" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md105"></a>
Dependencies</h2>
<p>External Dependencies (installed via <code>setup.py</code>):</p>
<ul>
<li><a href="https://github.com/kislyuk/argcomplete">argcomplete</a> - Used to implement tab completion</li>
</ul>
<p>Internal Dependencies (i.e. Other F' modules)</p>
<ul>
<li>Integration Test API - Used to get data from and send commands to the GDS and filter incoming data via the included predicates</li>
<li><code>common/pipeline</code> and <code>common/utils</code> - Used to initialize the Test API; <code>pipeline.dictionaries</code> also used to get a list of available commands/events/channels</li>
<li>GDS Data <a class="el" href="namespace_types.html">Types</a> in <code>common/data_types</code> - Used to handle incoming GDS data and for printing output</li>
<li><code>fprime_gds/flask/json.py</code> - Used for the <code>--json</code> printing flag implementation</li>
<li><code>executables/cli.py</code> - Used to automatically search for a dictionary file while parsing</li>
</ul>
<p>Important Python <code>stdlib</code> Dependencies:</p>
<ul>
<li><code>argparse</code> - Used to handle parsing user input</li>
</ul>
<h2><a class="anchor" id="autotoc_md106"></a>
Source Files</h2>
<p>Parsing files (in <code>executables</code>)</p>
<ul>
<li><b>fprime_cli.py</b> - Handles user input to the CLI tools via Python's <code>argparse</code> library; defines a base class for parsing and a subclass for each command. Uses <code>argcomplete</code> to handle tab completion if it's enabled, <code>cli.py</code> to search for a dictionary file, and then executes the appropriate command's function.</li>
</ul>
<p>Command files (in <code>common/gds_cli</code>):</p>
<ul>
<li><b>channels.py</b> - Displays and filters received telemetry channel data. Handles printing and listing data; most functionality comes from <code>base_commands.py</code>.</li>
<li><b>command_send.py</b> - Sends a given command to the GDS and prints an appropriate error message if this fails, and prints available commands. Filtering functionality comes from <code>base_commands.py</code>.</li>
<li><b>events.py</b> - Displays and filters received telemetry channel data. Handles printing and listing data; most functionality comes from <code>base_commands.py</code>.</li>
</ul>
<p>Common files (in <code>common/gds_cli</code>):</p>
<ul>
<li><b>base_commands.py</b> - Defines a base class for implementing commands with logging, and a child class for receiving and filtering GDS data</li>
<li><b>test_api_utils.py</b> - Defines functions for initializing the Integration Test API and receiving data from the API</li>
<li><b>filtering_utils.py</b> - Defines classes and functions used to filter GDS data using the Integration Test API's predicates</li>
<li><b>misc_utils.py</b> - Any other functions used by multiple CLI commands that haven't been categorized (currently includes string formatting functions and shared datatypes for CLI arguments)</li>
</ul>
<h1><a class="anchor" id="autotoc_md107"></a>
Tests</h1>
<p>The GDS CLI tests can be found at <code>Gds/test/fprime/common/gds_cli</code>, and currently includes 2 unit test files:</p>
<ul>
<li><code>filtering_utils_test.py</code> tests that filtering lists and GDS data work as expected</li>
<li><code>utils_test.py</code> tests <code>misc_utils</code> and <code>test_api_utils</code> functions, verifying that commands listening for data exit when interrupted, and that getting lists of items works successfully</li>
</ul>
<p>Test coverage is fairly low; there are currently no integration tests for the CLI.</p>
<h1><a class="anchor" id="autotoc_md108"></a>
Code Quirks</h1>
<ul>
<li><code>fprime_cli.py</code> and <code>misc_utils.py</code> use delayed/lazy importing to avoid slow performance from several particularly long imports<ul>
<li>In particular, <code>fprime_gds/flask/json.py</code> and <code>common/logger/test_logger.py</code> each take 100ms+ to import</li>
<li>The script takes noticeably longer to run if the optional <code>openpyxl</code> is installed since it's a slow import for the Test API</li>
</ul>
</li>
<li>While technically true for all GDS python code, the <a href="https://github.com/ninjaaron/fast-entry_points">fast_entry_points</a> script was used to improve startup speed<ul>
<li>Low startup times are especially important because tab completion re-runs the script each time tab is hit</li>
</ul>
</li>
<li>Code uses type hints, introduced in Python 3.5</li>
<li>Commands don't bother initializing the Test API when passed the <code>--list</code> option for performance reasons</li>
<li>The parsing/command classes currently have all their functionality implemented on class methods and are never instantiated</li>
<li>Printing uses <code>SysData</code> printing methods, which means console output will change if those <code>SysData</code> methods change</li>
<li>When used for filtering, the <code>filtering_util</code> predicates are called on entire <code>SysData</code> objects</li>
<li>New event/channel retrieval methods defined in <code>test_api_utils</code> instead of using the Test API's existing <code>await_telemetry</code>/etc. methods, since those only accept predicates filtering by time or one of the predefined <code>telemetry_predicate</code> or <code>event_predicate</code> fields; defining our own methods lets us use any predicate that will accept a <code>SysData</code> object<ul>
<li>This lets us also filter by component, printed strings, etc. at the cost of having slightly more complicated predicates</li>
</ul>
</li>
<li>The <code>search</code> filter option doesn't take multiple arguments like the other filtering options (done to allow for multi-word string queries more easily, but might not be worth breaking the multiple-filter pattern of the other ones)</li>
<li>CLI filters are inclusive OR with themselves but exclusive to one another (e.g. passing multiple <code>ids</code> will show all data with any of those ID types, but passing <code>--ids</code> and <code>--search</code> will only show data with those IDs AND having that search term)</li>
<li>MVC isn't strictly followed, since the base command class has a logging method for convenience (and since we have to print on data receipt), but parsing is separated from execution code</li>
</ul>
<h1><a class="anchor" id="autotoc_md109"></a>
Future Work</h1>
<h2><a class="anchor" id="autotoc_md110"></a>
Fixing Issues</h2>
<ul>
<li>Getting tab completion to automatically install, rather than be user-activated (headache since the user has to source a script from <code>argcomplete</code>)</li>
<li>Improve performance<ul>
<li>Fix the problem of just having <code>openpyxl</code> installed slowing the script down because of import time</li>
<li>Test API is slow to shut down for some reason, due to a slow thread join</li>
</ul>
</li>
<li>Create basic integration tests for each CLI tool to make sure they work successfully end-to-end</li>
</ul>
<h2><a class="anchor" id="autotoc_md111"></a>
New Features</h2>
<ul>
<li>Adding CLI tools for file uplink/downlink</li>
<li>Extending tab completion to component names/opcodes/etc.</li>
<li>Immediate value querying (i.e. ask what the value of a channel/etc. is now, instead of just recording updates)<ul>
<li>Nice-to-have, may not be possible with Integration Test API</li>
</ul>
</li>
<li>Having colored output to improve readability</li>
<li>Talk to testers using the GDS to figure out useful quality-of-life features </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
