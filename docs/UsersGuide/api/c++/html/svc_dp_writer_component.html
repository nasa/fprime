<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>F´ Flight Software - C/C++ Documentation: Svc::DpWriter Component</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">F´ Flight Software - C/C++ Documentation
   &#160;<span id="projectnumber">devel</span>
   </div>
   <div id="projectbrief">A framework for building embedded system applications to NASA flight quality standards.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_svc_dp_writer_component.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="class_svc_1_1_dp_writer.html">Svc::DpWriter</a> Component </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md833"></a>
Svc::DpWriter (Active Component)</h1>
<h2><a class="anchor" id="autotoc_md834"></a>
1. Introduction</h2>
<p><code><a class="el" href="class_svc_1_1_dp_writer.html">Svc::DpWriter</a></code> is an active component for writing data products to disk. It does the following:</p>
<ol type="1">
<li>Receive buffers containing filled data product containers. The buffers typically come from one or more components that produce data products. They typically pass through an instance of <a class="el" href="svc_2_dp_manager_2docs_2sdd_8md.html">`Svc::DpManager`</a>, and possibly through an instance of <a class="el" href="buffer_accumulator_8md.html">`Svc::BufferAccumulator`</a>, before reaching <code>DpWriter</code>.</li>
</ol>
<ol type="1">
<li>For each buffer <em>B</em> received in step 1:<ol type="a">
<li>Perform any requested processing, such as data compression, on <em>B</em>.</li>
</ol>
<ol type="a">
<li>Write <em>B</em> to disk.</li>
</ol>
<ol type="a">
<li>If a notification port is connected, then send out a notification that the write occurred. An instance of <a class="el" href="svc_2_dp_catalog_2docs_2sdd_8md.html">`Svc::DpCatalog`</a> can receive this notification and use it to update the data product catalog.</li>
</ol>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md835"></a>
2. Requirements</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Requirement   </th><th class="markdownTableHeadNone">Description   </th><th class="markdownTableHeadNone">Rationale   </th><th class="markdownTableHeadNone">Verification Method    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SVC-DPWRITER-001   </td><td class="markdownTableBodyNone"><code><a class="el" href="class_svc_1_1_dp_writer.html">Svc::DpWriter</a></code> shall provide a port for receiving <code><a class="el" href="class_fw_1_1_buffer.html">Fw::Buffer</a></code> objects pointing to filled data product containers.   </td><td class="markdownTableBodyNone">The purpose of <code>DpWriter</code> is to write the data products to disk.   </td><td class="markdownTableBodyNone">Unit Test    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SVC-DPWRITER-002   </td><td class="markdownTableBodyNone"><code><a class="el" href="class_svc_1_1_dp_writer.html">Svc::DpWriter</a></code> shall provide an array of ports for sending <code><a class="el" href="class_fw_1_1_buffer.html">Fw::Buffer</a></code> objects for processing.   </td><td class="markdownTableBodyNone">This requirement supports downstream processing of the data in the buffer.   </td><td class="markdownTableBodyNone">Unit Test    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SVC-DPWRITER-003   </td><td class="markdownTableBodyNone">On receiving a data product container <em>C</em>, <code><a class="el" href="class_svc_1_1_dp_writer.html">Svc::DpWriter</a></code> shall use the processing type field of the header of <em>C</em> to select zero or more processing ports to invoke, in port order.   </td><td class="markdownTableBodyNone">The processing type field is a bit mask. A one in bit <code>2^n</code> in the bit mask selects port index <code>n</code>.   </td><td class="markdownTableBodyNone">Unit Test    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SVC-DPWRITER-004   </td><td class="markdownTableBodyNone">On receiving an <code><a class="el" href="class_fw_1_1_buffer.html">Fw::Buffer</a></code> <em>B</em>, and after performing any requested processing on <em>B</em>, <code><a class="el" href="class_svc_1_1_dp_writer.html">Svc::DpWriter</a></code> shall write <em>B</em> to disk.   </td><td class="markdownTableBodyNone">The purpose of <code>DpWriter</code> is to write data products to the disk.   </td><td class="markdownTableBodyNone">Unit Test    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SVC-DPWRITER-005   </td><td class="markdownTableBodyNone"><code><a class="el" href="class_svc_1_1_dp_writer.html">Svc::DpWriter</a></code> shall provide a port for notifying other components that data products have been written.   </td><td class="markdownTableBodyNone">This requirement allows <code><a class="el" href="class_svc_1_1_dp_catalog.html">Svc::DpCatalog</a></code> or a similar component to update its catalog in real time.   </td><td class="markdownTableBodyNone">Unit Test    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SVC-DPWRITER-006   </td><td class="markdownTableBodyNone"><code><a class="el" href="class_svc_1_1_dp_manager.html">Svc::DpManager</a></code> shall provide telemetry that reports the number of buffers received, the number of data products written, the number of bytes written, the number of failed writes, and the number of errors.   </td><td class="markdownTableBodyNone">This requirement establishes the telemetry interface for the component.   </td><td class="markdownTableBodyNone">Unit test   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md836"></a>
3. Design</h2>
<h3><a class="anchor" id="autotoc_md837"></a>
3.1. Component Diagram</h3>
<p>The diagram below shows the <code>DpWriter</code> component.</p>
<div> <img src="img/DpWriter.png" alt="" width="700/" class="inline"/> </div><h3><a class="anchor" id="autotoc_md838"></a>
3.2. Ports</h3>
<p><code>DpWriter</code> has the following ports:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Kind   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Port Type   </th><th class="markdownTableHeadNone">Usage    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>async input</code>   </td><td class="markdownTableBodyNone"><code>schedIn</code>   </td><td class="markdownTableBodyNone"><code>Svc.Sched</code>   </td><td class="markdownTableBodyNone">Schedule in port    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>async input</code>   </td><td class="markdownTableBodyNone"><code>bufferSendIn</code>   </td><td class="markdownTableBodyNone"><code>Fw.BufferSend</code>   </td><td class="markdownTableBodyNone">Port for receiving data products to write to disk    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>output</code>   </td><td class="markdownTableBodyNone"><code>procBufferSendOut</code>   </td><td class="markdownTableBodyNone"><code>[DpWriterNumProcPorts] Fw.BufferSend</code>   </td><td class="markdownTableBodyNone">Port for processing data products    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>output</code>   </td><td class="markdownTableBodyNone"><code>dpWrittenOut</code>   </td><td class="markdownTableBodyNone"><code>DpWritten</code>   </td><td class="markdownTableBodyNone">Port for sending <code>DpWritten</code> notifications    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>output</code>   </td><td class="markdownTableBodyNone"><code>deallocBufferSendOut</code>   </td><td class="markdownTableBodyNone"><code>Fw.BufferSend</code>   </td><td class="markdownTableBodyNone">Port for deallocating data product buffers    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>time get</code>   </td><td class="markdownTableBodyNone"><code>timeGetOut</code>   </td><td class="markdownTableBodyNone"><code><a class="el" href="class_fw_1_1_time.html">Fw.Time</a></code>   </td><td class="markdownTableBodyNone">Time get port    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>telemetry</code>   </td><td class="markdownTableBodyNone"><code>tlmOut</code>   </td><td class="markdownTableBodyNone"><code>Fw.Tlm</code>   </td><td class="markdownTableBodyNone">Telemetry port    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>event</code>   </td><td class="markdownTableBodyNone"><code>eventOut</code>   </td><td class="markdownTableBodyNone"><code>Fw.Log</code>   </td><td class="markdownTableBodyNone">Event port    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>text event</code>   </td><td class="markdownTableBodyNone"><code>textEventOut</code>   </td><td class="markdownTableBodyNone"><code>Fw.LogText</code>   </td><td class="markdownTableBodyNone">Text event port   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md839"></a>
3.3. State</h3>
<p><code>DpWriter</code> maintains the following state:</p>
<ol type="1">
<li><code>numDataProducts (U32)</code>: The number of data products written.</li>
</ol>
<ol type="1">
<li><code>numBytes (U64)</code>: The number of bytes written.</li>
</ol>
<h3><a class="anchor" id="autotoc_md840"></a>
3.4. Compile-Time Setup</h3>
<ol type="1">
<li>The configuration constant <a href="../../../config/AcConstants.fpp"><code>DpWriterNumProcPorts</code></a> specifies the number of ports for connecting components that perform processing.</li>
</ol>
<ol type="1">
<li>The configuration <a href="../../../config/DpCfg.hpp"><code>DP_FILENAME_FORMAT</code></a> specifies the file name format.</li>
</ol>
<h3><a class="anchor" id="autotoc_md841"></a>
3.5. Runtime Setup</h3>
<p>You can call the <code>configure</code> function to supply the DP file name prefix. This is the prefix used when constructing names of files to write. For more information about the file name format, see the <a href="#file_format"><b>File Format</b></a> section.</p>
<p>If you do not call the <code>configure</code> function, then the default DP file name prefix is the empty string.</p>
<h3><a class="anchor" id="autotoc_md842"></a>
3.6. Port Handlers</h3>
<h4><a class="anchor" id="autotoc_md843"></a>
3.6.1. schedIn</h4>
<p>This handler sends out the state variables as telemetry.</p>
<h4><a class="anchor" id="autotoc_md844"></a>
3.6.2. bufferSendIn</h4>
<p>This handler receives a mutable reference to a buffer <code>B</code>. It does the following:</p>
<ol type="1">
<li>Check that <code>B</code> is valid. If not, emit a warning event.</li>
</ol>
<ol type="1">
<li>If the previous step succeeded, then check that the size of <code>B</code> is large enough to hold a data product container packet. If not, emit a warning event.</li>
</ol>
<ol type="1">
<li>If the previous steps succeeded, then check that the packet header of <code>B</code> can be successfully deserialized. If not, emit a warning event.</li>
</ol>
<ol type="1">
<li>If the previous steps succeeded, then check that the header hash of <code>B</code> is valid. If not, emit a warning event.</li>
</ol>
<ol type="1">
<li>If the previous steps succeeded, then check that the data size recorded in the packet header fits within the buffer. If not, emit a warning event.</li>
</ol>
<ol type="1">
<li>If the previous steps succeeded, then<ol type="a">
<li>Read the <code>ProcType</code> field out of the container header stored in the memory pointed to by <code>B</code>. Let the resulting bit mask be <code>M</code>.</li>
</ol>
<ol type="a">
<li>Visit the port numbers of <code>procBufferSendOut</code> in order. For each port number <code>N</code>, if <code>N</code> is set in <code>M</code>, then invoke <code>procBufferSendOut</code> at port number <code>N</code>, passing in <code>B</code>. This step updates the memory pointed to by <code>B</code> in place.</li>
</ol>
<ol type="a">
<li>Write <code>B</code> to a file, using the format described in the <a href="#file_format"><b>File Format</b></a> section. For the time stamp, use the time provided by <code>timeGetOut</code>.</li>
</ol>
</li>
</ol>
<ol type="1">
<li>If the file write succeeded and <code>dpWrittenOut</code> is connected, then send the file name, priority, and file size out on <code>dpWrittenOut</code>.</li>
</ol>
<ol type="1">
<li>If <code>B</code> is valid, then send <code>B</code> on <code>deallocBufferSendOut</code>.</li>
</ol>
<p><a class="anchor" id="file_format"></a> </p>
<h2><a class="anchor" id="autotoc_md845"></a>
4. File Format</h2>
<h3><a class="anchor" id="autotoc_md846"></a>
4.1. Data Format</h3>
<p>Each file stores a serialized data product record, with the format described in the <a href="../../../Fw/Dp/docs/sdd.md#serial-format">data products documentation</a>.</p>
<h3><a class="anchor" id="autotoc_md847"></a>
4.2. File Name</h3>
<p>The name of each file is formatted with the configurable format string <a href="../../../config/DpCfg.hpp"><code>DP_FILENAME_FORMAT</code></a>. The format string must contain format specifications for the following arguments, in order.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Format Specifier   </th><th class="markdownTableHeadNone">Type    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">The DP file name prefix   </td><td class="markdownTableBodyNone"><code>s</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Container ID   </td><td class="markdownTableBodyNone"><code>PRI_FwDpIdType</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Time seconds   </td><td class="markdownTableBodyNone"><code>PRI_u32</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Time microseconds   </td><td class="markdownTableBodyNone"><code>PRI_u32</code>   </td></tr>
</table>
<p>The exact meaning of the DP file name prefix depends on the format string. Typically it is a directory path prefix.</p>
<p><a class="anchor" id="ground_interface"></a> </p>
<h2><a class="anchor" id="autotoc_md848"></a>
5. Ground Interface</h2>
<h3><a class="anchor" id="autotoc_md849"></a>
5.1. Commands</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Kind   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>async</code>   </td><td class="markdownTableBodyNone"><code>CLEAR_EVENT_THROTTLE</code>   </td><td class="markdownTableBodyNone">Clear event throttling   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md850"></a>
5.2. Telemetry</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>NumDataProducts</code>   </td><td class="markdownTableBodyNone"><code>U32</code>   </td><td class="markdownTableBodyNone">The number of data products handled    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>NumBytes</code>   </td><td class="markdownTableBodyNone"><code>U64</code>   </td><td class="markdownTableBodyNone">The number of bytes handled   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md851"></a>
5.3. Events</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Severity   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>BufferInvalid</code>   </td><td class="markdownTableBodyNone"><code>warning high</code>   </td><td class="markdownTableBodyNone">Incoming buffer is invalid    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>BufferTooSmall</code>   </td><td class="markdownTableBodyNone"><code>warning high</code>   </td><td class="markdownTableBodyNone">Incoming buffer is too small to hold a data product container    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>InvalidPacketDescriptor</code>   </td><td class="markdownTableBodyNone"><code>warning high</code>   </td><td class="markdownTableBodyNone">Incoming buffer has an invalid packet descriptor    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>FileOpenError</code>   </td><td class="markdownTableBodyNone"><code>warning high</code>   </td><td class="markdownTableBodyNone">An error occurred when opening a file    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>FileWriteError</code>   </td><td class="markdownTableBodyNone"><code>warning high</code>   </td><td class="markdownTableBodyNone">An error occurred when writing to a file   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md852"></a>
6. Example Uses</h2>
<p><a class="anchor" id="top-diagrams"></a> </p>
<h3><a class="anchor" id="autotoc_md853"></a>
6.1. Topology Diagrams</h3>
<p>The following topology diagram shows how to connect <code><a class="el" href="class_svc_1_1_dp_writer.html">Svc::DpWriter</a></code> to a <code>DpManager</code> component and a processor component. The diagrams use the following instances:</p>
<ul>
<li><code>dpManager</code>: An instance of <a class="el" href="svc_2_dp_manager_2docs_2sdd_8md.html">`Svc::DpManager`</a>.</li>
<li><code>dpProcessor</code>: A component that processes data product containers.</li>
<li><code>dpWriter</code>: An instance of <code><a class="el" href="class_svc_1_1_dp_writer.html">Svc::DpWriter</a></code>.</li>
<li><code>producer</code>: A component that produces data products.</li>
</ul>
<div> <img src="img/top/product-write.png" alt="" width="800/" class="inline"/> </div><h3><a class="anchor" id="autotoc_md854"></a>
6.2. Sequence Diagrams</h3>
<p>The following diagram shows what happens when a buffer is sent to <code>DpWriter</code>, is processed, and is written to disk.</p>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    activate producer</div>
<div class="line">    activate dpManager</div>
<div class="line">    activate dpWriter</div>
<div class="line">    producer-)dpManager: Send buffer</div>
<div class="line">    dpManager-)dpWriter: Send buffer [bufferSendIn]</div>
<div class="line">    dpWriter-&gt;&gt;dpProcessor: Process buffer B [procBufferSendOut]</div>
<div class="line">    dpProcessor--&gt;&gt;dpWriter: Return</div>
<div class="line">    dpWriter-&gt;&gt;dpWriter: Write B to disk</div>
<div class="line">    dpWriter-&gt;&gt;bufferManager: Deallocate B [deallocBufferSendOut]</div>
<div class="line">    bufferManager--&gt;&gt;dpWriter: Return</div>
<div class="line">    deactivate dpWriter</div>
<div class="line">    deactivate dpManager</div>
<div class="line">    deactivate producer</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
