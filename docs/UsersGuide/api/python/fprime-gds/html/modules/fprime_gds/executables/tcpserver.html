

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>fprime_gds.executables.tcpserver &mdash; fprime-gds 1.4.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../static/css/rtd_width.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../static/documentation_options.js"></script>
        <script src="../../../static/jquery.js"></script>
        <script src="../../../static/underscore.js"></script>
        <script src="../../../static/doctools.js"></script>
        <script src="../../../static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> fprime-gds
          

          
          </a>

          
            
            
              <div class="version">
                1.4.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">fprime-gds</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../fprime_gds.html">fprime_gds</a> &raquo;</li>
        
      <li>fprime_gds.executables.tcpserver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for fprime_gds.executables.tcpserver</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>

<span class="kn">from</span> <span class="nn">fprime.constants</span> <span class="kn">import</span> <span class="n">DATA_ENCODING</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">socketserver</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">SocketServer</span> <span class="k">as</span> <span class="nn">socketserver</span>


<div class="viewcode-block" id="__version__"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.__version__">[docs]</a><span class="n">__version__</span> <span class="o">=</span> <span class="mf">0.1</span></div>
<div class="viewcode-block" id="__date__"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.__date__">[docs]</a><span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;2015-04-03&quot;</span></div>
<div class="viewcode-block" id="__updated__"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.__updated__">[docs]</a><span class="n">__updated__</span> <span class="o">=</span> <span class="s2">&quot;2016-04-07&quot;</span></div>

<span class="c1"># Universal server id global</span>
<div class="viewcode-block" id="SERVER"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.SERVER">[docs]</a><span class="n">SERVER</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="LOCK"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.LOCK">[docs]</a><span class="n">LOCK</span> <span class="o">=</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="shutdown_event"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.shutdown_event">[docs]</a><span class="n">shutdown_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span></div>

<div class="viewcode-block" id="FSW_clients"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.FSW_clients">[docs]</a><span class="n">FSW_clients</span> <span class="o">=</span> <span class="p">[]</span></div>
<div class="viewcode-block" id="GUI_clients"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.GUI_clients">[docs]</a><span class="n">GUI_clients</span> <span class="o">=</span> <span class="p">[]</span></div>
<div class="viewcode-block" id="FSW_ids"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.FSW_ids">[docs]</a><span class="n">FSW_ids</span> <span class="o">=</span> <span class="p">[]</span></div>
<div class="viewcode-block" id="GUI_ids"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.GUI_ids">[docs]</a><span class="n">GUI_ids</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="signal_handler"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.signal_handler">[docs]</a><span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ctrl-C received, server shutting down.&quot;</span><span class="p">)</span>
    <span class="n">shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>


<div class="viewcode-block" id="now"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.now">[docs]</a><span class="k">def</span> <span class="nf">now</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span></div>


<div class="viewcode-block" id="ThreadedTCPRequestHandler"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPRequestHandler">[docs]</a><span class="k">class</span> <span class="nc">ThreadedTCPRequestHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">StreamRequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Derived from original Stable demo during R&amp;TD and adapted</span>
<span class="sd">    for use in new FSW gse.py application.</span>

<span class="sd">    TCP socket server for commands, log events, and telemetry data.</span>
<span class="sd">    Later this will handle other things such as sequence files and parameters.</span>

<span class="sd">    Handle is instanced in own thread for each client.</span>

<span class="sd">    Registration is done by sending the string &quot;Register &lt;name&gt;&quot;.</span>
<span class="sd">    Sending a message to destination &lt;name&gt; is done as</span>
<span class="sd">    &quot;A5A5 &lt;name&gt; &lt;data&gt;&quot; Note only &lt;data&gt; is sent.</span>
<span class="sd">    Any client that sends a &quot;List&quot; comment makes the server display all</span>
<span class="sd">    registered clients.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ThreadedTCPRequestHandler.allow_reuse_address"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPRequestHandler.allow_reuse_address">[docs]</a>    <span class="n">socketserver</span><span class="o">.</span><span class="n">StreamRequestHandler</span><span class="o">.</span><span class="n">allow_reuse_address</span> <span class="o">=</span> <span class="kc">True</span></div>
<div class="viewcode-block" id="ThreadedTCPRequestHandler.timeout"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPRequestHandler.timeout">[docs]</a>    <span class="n">socketserver</span><span class="o">.</span><span class="n">StreamRequestHandler</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="ThreadedTCPRequestHandler.handle"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPRequestHandler.handle">[docs]</a>    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># on each client connect</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function that is invoked upon a new client.  This function listens</span>
<span class="sd">        for data on the socket.  Packets for now are assumed to be separated</span>
<span class="sd">        by a newline.  For each packet, call processPkt.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">partial</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmdQueue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># print self.client_address, now()        # show this client&#39;s address</span>
        <span class="c1"># Read the data from the socket</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>

        <span class="c1"># Connection was closed by the client</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Client exited.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Process the data into the cmdQueue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getCmds</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="c1"># Process the cmdQueue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processQueue</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Registration complete waiting for message.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getNewMsg</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unable to register client.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">LOCK</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">SERVER</span><span class="o">.</span><span class="n">dest_obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">FSW_clients</span><span class="p">:</span>
            <span class="n">FSW_clients</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">FSW_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">GUI_clients</span><span class="p">:</span>
            <span class="n">GUI_clients</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">GUI_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">LOCK</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closed </span><span class="si">%s</span><span class="s2"> connection.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">DATA_ENCODING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="ThreadedTCPRequestHandler.getCmds"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPRequestHandler.getCmds">[docs]</a>    <span class="k">def</span> <span class="nf">getCmds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputString</span><span class="p">,</span> <span class="n">end_of_command</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a command from partial or full socket input</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="n">inputString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">end_of_command</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partial</span><span class="p">):</span>
            <span class="n">commands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial</span> <span class="o">+</span> <span class="n">commands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial</span> <span class="o">=</span> <span class="n">commands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmdQueue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">commands</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmdQueue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">commands</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="ThreadedTCPRequestHandler.processQueue"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPRequestHandler.processQueue">[docs]</a>    <span class="k">def</span> <span class="nf">processQueue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdQueue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processRegistration</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmdQueue</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="ThreadedTCPRequestHandler.processRegistration"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPRequestHandler.processRegistration">[docs]</a>    <span class="k">def</span> <span class="nf">processRegistration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">process_id</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;Register&quot;</span><span class="p">:</span>
            <span class="n">LOCK</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;FSW&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">FSW_clients</span><span class="p">:</span>
                    <span class="n">process_id</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">FSW_ids</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">process_id</span><span class="p">)</span>
                <span class="n">FSW_clients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">FSW_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="sa">b</span><span class="s2">&quot;GUI&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">GUI_clients</span><span class="p">:</span>
                    <span class="n">process_id</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">GUI_ids</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">process_id</span><span class="p">)</span>
                <span class="n">GUI_clients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">GUI_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_id</span><span class="p">)</span>

            <span class="n">SERVER</span><span class="o">.</span><span class="n">dest_obj</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">DestObj</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
            <span class="n">LOCK</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">registered</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">process_id</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Registered client &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">DATA_ENCODING</span><span class="p">))</span></div>

    <span class="c1">#################################################</span>
    <span class="c1"># New Routines to process the command messages</span>
    <span class="c1">#################################################</span>
<div class="viewcode-block" id="ThreadedTCPRequestHandler.getNewMsg"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPRequestHandler.getNewMsg">[docs]</a>    <span class="k">def</span> <span class="nf">getNewMsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        After registration wait for an incoming message</span>
<span class="sd">        The first part must always be an &quot;A5A5 &quot; or a &quot;List &quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Loop while the connected client has packets to send/receive</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="c1"># Read the header data from the socket either A5A5 or List</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readHeader</span><span class="p">()</span>

            <span class="c1"># If the received header is an empty string, connection closed, exit loop</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">elif</span> <span class="n">header</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;Quit&quot;</span><span class="p">:</span>
                <span class="n">LOCK</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quit received!&quot;</span><span class="p">)</span>
                <span class="n">SERVER</span><span class="o">.</span><span class="n">dest_obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="mh">0xA5A5A5A5</span><span class="p">))</span>
                <span class="n">shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quit processed!&quot;</span><span class="p">)</span>
                <span class="n">SERVER</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="n">SERVER</span><span class="o">.</span><span class="n">server_close</span><span class="p">()</span>
                <span class="n">LOCK</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">break</span>

            <span class="c1"># Got the header data so read the data of the message here...</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readData</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

            <span class="c1"># Process and send the packet of the message here...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processNewPkt</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThreadedTCPRequestHandler.recv"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPRequestHandler.recv">[docs]</a>    <span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read l bytes from socket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">chunk</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;read data from socket is empty!&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="n">chunk</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;socket timed out and shutdown is requested&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;Quit</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Socket error &quot;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">errno</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot; (Connection reset by peer) occurred on recv().&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Socket error &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">errno</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; occurred on recv().&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="ThreadedTCPRequestHandler.readHeader"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPRequestHandler.readHeader">[docs]</a>    <span class="k">def</span> <span class="nf">readHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the 9 byte header (e.g. &quot;A5A5 GUI &quot; or &quot;A5A5 FSW &quot;),</span>
<span class="sd">        or just read the &quot;List\n&quot; command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Header information is empty, client &quot;</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">DATA_ENCODING</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; exiting.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">header</span>
        <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;List</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;List&quot;</span>
        <span class="k">elif</span> <span class="n">header</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;Quit</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;Quit&quot;</span>
        <span class="k">elif</span> <span class="n">header</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;A5A5&quot;</span><span class="p">:</span>
            <span class="n">header2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">header</span> <span class="o">+</span> <span class="n">header2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="ThreadedTCPRequestHandler.readData"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPRequestHandler.readData">[docs]</a>    <span class="k">def</span> <span class="nf">readData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the data part of the message sent to either GUI or FSW.</span>
<span class="sd">        GUI receives telemetry.</span>
<span class="sd">        FSW receives commands of various lengths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;List&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">header</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;Quit&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dst</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;FSW&quot;</span><span class="p">:</span>
            <span class="c1"># Read variable length command data here...</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">sizeb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="n">sizeb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">desc</span> <span class="o">+</span> <span class="n">sizeb</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dst</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;GUI&quot;</span><span class="p">:</span>
            <span class="c1"># Read telemetry data here...</span>
            <span class="n">tlm_packet_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="n">tlm_packet_size</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tlm_packet_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;unrecognized client </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dst</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">DATA_ENCODING</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="ThreadedTCPRequestHandler.processNewPkt"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPRequestHandler.processNewPkt">[docs]</a>    <span class="k">def</span> <span class="nf">processNewPkt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a single command here header and data here.</span>
<span class="sd">        The command must always start with A5A5 except if it is a List.</span>
<span class="sd">        Once the entire header tstring is processed send it on queue.</span>
<span class="sd">        If something goes wrong report and shutdown server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dest_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;List&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;List of registered clients: &quot;</span><span class="p">)</span>
            <span class="n">LOCK</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">SERVER</span><span class="o">.</span><span class="n">dest_obj</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">SERVER</span><span class="o">.</span><span class="n">dest_obj</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">DATA_ENCODING</span><span class="p">))</span>
                <span class="n">reg_client_str</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;List &quot;</span> <span class="o">+</span> <span class="n">SERVER</span><span class="o">.</span><span class="n">dest_obj</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_client_str</span><span class="p">)</span>
                <span class="n">reg_client_str</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;i</span><span class="si">%d</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">reg_client_str</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">reg_client_str</span><span class="p">)</span>
            <span class="n">LOCK</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># Process data here...</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">head</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;A5A5&quot;</span><span class="p">:</span>  <span class="c1"># Packet Header</span>
            <span class="c1"># print &quot;Received Packet: %s %s...\n&quot; % (head,dst)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Data is empty, returning.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;GUI&quot;</span> <span class="ow">in</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dest_list</span> <span class="o">=</span> <span class="n">GUI_clients</span>
            <span class="k">elif</span> <span class="sa">b</span><span class="s2">&quot;FSW&quot;</span> <span class="ow">in</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dest_list</span> <span class="o">=</span> <span class="n">FSW_clients</span>
            <span class="k">for</span> <span class="n">dest_elem</span> <span class="ow">in</span> <span class="n">dest_list</span><span class="p">:</span>
                <span class="c1"># print &quot;Locking TCP&quot;</span>
                <span class="n">LOCK</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">dest_elem</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">SERVER</span><span class="o">.</span><span class="n">dest_obj</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="c1"># Send the message here....</span>
                    <span class="c1"># print &quot;Sending TCP msg to &quot;, dest_elem</span>

                    <span class="n">SERVER</span><span class="o">.</span><span class="n">dest_obj</span><span class="p">[</span><span class="n">dest_elem</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">LOCK</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Packet missing A5A5 header&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ThreadedUDPRequestHandler"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedUDPRequestHandler">[docs]</a><span class="k">class</span> <span class="nc">ThreadedUDPRequestHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Derived from original Stable demo during R&amp;TD and adapted</span>
<span class="sd">    for use in new FSW gse.py application.</span>

<span class="sd">    TCP socket server for commands, log events, and telemetry data.</span>
<span class="sd">    Later this will handle other things such as sequence files and parameters.</span>

<span class="sd">    Handle is instanced in own thread for each client.</span>

<span class="sd">    Registration is done by sending the string &quot;Register &lt;name&gt;&quot;.</span>
<span class="sd">    Sending a message to destination &lt;name&gt; is done as</span>
<span class="sd">    &quot;A5A5 &lt;name&gt; &lt;data&gt;&quot; Note only &lt;data&gt; is sent.</span>
<span class="sd">    Any client that sends a &quot;List&quot; comment makes the server display all</span>
<span class="sd">    registered clients.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ThreadedUDPRequestHandler.allow_reuse_address"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedUDPRequestHandler.allow_reuse_address">[docs]</a>    <span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="o">.</span><span class="n">allow_reuse_address</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ThreadedUDPRequestHandler.handle"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedUDPRequestHandler.handle">[docs]</a>    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># on each packet</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function that is invoked when a packet is received.  This function listens</span>
<span class="sd">        for data on the socket.  Packets for now are assumed to be separated</span>
<span class="sd">        by a newline.  For each packet, call processPkt.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">getNewMsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="c1">#################################################</span>
    <span class="c1"># New Routines to process the command messages</span>
    <span class="c1">#################################################</span>
<div class="viewcode-block" id="ThreadedUDPRequestHandler.getNewMsg"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedUDPRequestHandler.getNewMsg">[docs]</a>    <span class="k">def</span> <span class="nf">getNewMsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        After registration wait for an incoming message</span>
<span class="sd">        The first part must always be an &quot;A5A5 &quot; or a &quot;List &quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Read the header data from the socket either A5A5 or List</span>
        <span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readHeader</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>

        <span class="c1"># If the received header is an empty string, connection closed, exit loop</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Got the header data so read the data of the message here...</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readData</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span>

        <span class="c1"># Process and send the packet of the message here...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processNewPkt</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThreadedUDPRequestHandler.readHeader"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedUDPRequestHandler.readHeader">[docs]</a>    <span class="k">def</span> <span class="nf">readHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the 9 byte header (e.g. &quot;A5A5 GUI &quot; or &quot;A5A5 FSW &quot;),</span>
<span class="sd">        or just read the &quot;List\n&quot; command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">header2</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">packet</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="n">header2</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThreadedUDPRequestHandler.readData"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedUDPRequestHandler.readData">[docs]</a>    <span class="k">def</span> <span class="nf">readData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">packet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the data part of the message sent to either GUI or FSW.</span>
<span class="sd">        GUI receives telemetry.</span>
<span class="sd">        FSW receives commands of various lengths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="c1"># Read telemetry data here...</span>
        <span class="n">tlm_packet_size</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="n">tlm_packet_size</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">tlm_packet_size</span> <span class="o">+</span> <span class="n">packet</span><span class="p">[</span><span class="mi">4</span> <span class="p">:</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">size</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="ThreadedUDPRequestHandler.processNewPkt"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedUDPRequestHandler.processNewPkt">[docs]</a>    <span class="k">def</span> <span class="nf">processNewPkt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a single command here header and data here.</span>
<span class="sd">        The command must always start with A5A5 except if it is a List.</span>
<span class="sd">        Once the entire header string is processed send it on queue.</span>
<span class="sd">        If something goes wrong report and shutdown server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dest_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Process data here...</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">head</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;A5A5&quot;</span><span class="p">:</span>  <span class="c1"># Packet Header</span>
            <span class="c1"># print &quot;Received Packet: %s %s...\n&quot; % (head,dst)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Data is empty, returning.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;GUI&quot;</span> <span class="ow">in</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dest_list</span> <span class="o">=</span> <span class="n">GUI_clients</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dest? </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dst</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">DATA_ENCODING</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">dest_elem</span> <span class="ow">in</span> <span class="n">dest_list</span><span class="p">:</span>
                <span class="n">LOCK</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">dest_elem</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">SERVER</span><span class="o">.</span><span class="n">dest_obj</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="c1"># Send the message here....</span>
                    <span class="c1"># print &quot;Sending UDP msg to &quot;, dest_elem</span>

                    <span class="n">SERVER</span><span class="o">.</span><span class="n">dest_obj</span><span class="p">[</span><span class="n">dest_elem</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">LOCK</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Telemetry missing A5A5 header&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ThreadedTCPServer"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPServer">[docs]</a><span class="k">class</span> <span class="nc">ThreadedTCPServer</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">ThreadingMixIn</span><span class="p">,</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TCP Socket server.</span>

<span class="sd">    Keep a dictionary of destination objects containing queues and</span>
<span class="sd">    socket id&#39;s for writting to destinations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ThreadedTCPServer.dest_obj"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPServer.dest_obj">[docs]</a>    <span class="n">dest_obj</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>
<div class="viewcode-block" id="ThreadedTCPServer.lock_obj"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedTCPServer.lock_obj">[docs]</a>    <span class="n">lock_obj</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ThreadedUDPServer"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.ThreadedUDPServer">[docs]</a><span class="k">class</span> <span class="nc">ThreadedUDPServer</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">ThreadingMixIn</span><span class="p">,</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">UDPServer</span><span class="p">):</span></div>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    UDP Socket server.</span>
<span class="sd">    &quot;&quot;&quot;</span>


<div class="viewcode-block" id="DestObj"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.DestObj">[docs]</a><span class="k">class</span> <span class="nc">DestObj</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Destination object for all clients registered.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packet</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="DestObj.put"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.DestObj.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write out the message to the destination socket</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># print &quot;about to send data to &quot; + self.name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Socket error &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">errno</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; occurred on send().&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DestObj.fileno"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.DestObj.fileno">[docs]</a>    <span class="k">def</span> <span class="nf">fileno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span></div></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../api/fprime_gds/executables/tcpserver/index.html#fprime_gds.executables.tcpserver.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">SERVER</span><span class="p">,</span> <span class="n">LOCK</span>

    <span class="n">program_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">program_license</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2015 user_name (California Institute of Technology)                                            </span><span class="se">\</span>
<span class="s2">                ALL RIGHTS RESERVED. U.S. Government Sponsorship acknowledged.&quot;</span>
    <span class="n">program_version</span> <span class="o">=</span> <span class="s2">&quot;v0.1&quot;</span>
    <span class="n">program_build_date</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">__updated__</span>
    <span class="n">program_version_string</span> <span class="o">=</span> <span class="s2">&quot;%prog </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">program_version</span><span class="p">,</span> <span class="n">program_build_date</span><span class="p">)</span>
    <span class="n">program_longdesc</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>  <span class="c1"># optional - give further explanation about what the program does</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">argv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="n">program_version_string</span><span class="p">,</span>
            <span class="n">epilog</span><span class="o">=</span><span class="n">program_longdesc</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">program_license</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
            <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--port&quot;</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;port&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set threaded tcp socket server port [default: </span><span class="si">%d</span><span class="s2">efault]&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="mi">50007</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
            <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--host&quot;</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;host&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set threaded tcp socket server ip [default: </span><span class="si">%d</span><span class="s2">efault]&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># process options</span>
        <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>

        <span class="n">HOST</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">host</span>
        <span class="n">PORT</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">port</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedTCPServer</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">),</span> <span class="n">ThreadedTCPRequestHandler</span><span class="p">)</span>
        <span class="n">udp_server</span> <span class="o">=</span> <span class="n">ThreadedUDPServer</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">),</span> <span class="n">ThreadedUDPRequestHandler</span><span class="p">)</span>
        <span class="c1"># Hopefully this will allow address reuse and server to restart immediately</span>
        <span class="n">server</span><span class="o">.</span><span class="n">allow_reuse_address</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">SERVER</span> <span class="o">=</span> <span class="n">server</span>
        <span class="n">LOCK</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">lock_obj</span>
        <span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">server_address</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TCP Socket Server listening on host addr </span><span class="si">{}</span><span class="s2">, port </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
        <span class="c1"># Start a thread with the server -- that thread will then start one</span>
        <span class="c1"># more thread for each request</span>
        <span class="n">server_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">)</span>
        <span class="n">udp_server_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">udp_server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
        <span class="n">server_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">udp_server_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">udp_server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="n">server_thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
            <span class="n">udp_server_thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shutdown from main thread&quot;</span><span class="p">)</span>

        <span class="n">SERVER</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">SERVER</span><span class="o">.</span><span class="n">server_close</span><span class="p">()</span>
        <span class="n">udp_server</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">udp_server</span><span class="o">.</span><span class="n">server_close</span><span class="p">()</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">program_name</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">program_name</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;  for help use --help</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">2</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Michael Starch

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
